version: '3.8'

# Airbyte ETL Platform with Multitenancy Support
# Integrated with existing Agent Memz stack

services:
  # Airbyte Database (uses existing PostgreSQL instance)
  # Run this SQL first: CREATE DATABASE airbyte;

  # Airbyte Server (API + Scheduler)
  airbyte-server:
    image: airbyte/server:0.50.33
    container_name: agent-memz-airbyte-server
    restart: unless-stopped
    environment:
      - DATABASE_USER=${POSTGRES_USER:-agentmemz}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD}
      - DATABASE_HOST=agent-memz-postgres
      - DATABASE_PORT=5432
      - DATABASE_DB=airbyte
      - CONFIG_ROOT=/data
      - WORKSPACE_ROOT=/tmp/workspace
      - TRACKING_STRATEGY=logging
      - WEBAPP_URL=https://etl.${DOMAIN}
      - API_URL=https://etl.${DOMAIN}/api/v1/
      - INTERNAL_API_HOST=airbyte-server:8001
      - WORKER_ENVIRONMENT=DOCKER
      - LOG_LEVEL=INFO
      - TEMPORAL_HOST=airbyte-temporal:7233
    volumes:
      - airbyte_data:/data
      - airbyte_workspace:/tmp/workspace
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - agent-network
      - coolify
    depends_on:
      - airbyte-temporal
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.airbyte-api.rule=Host(`etl.${DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.airbyte-api.entrypoints=https"
      - "traefik.http.routers.airbyte-api.tls=true"
      - "traefik.http.routers.airbyte-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.airbyte-api.loadbalancer.server.port=8001"

  # Airbyte Web UI
  airbyte-webapp:
    image: airbyte/webapp:0.50.33
    container_name: agent-memz-airbyte-webapp
    restart: unless-stopped
    environment:
      - AIRBYTE_VERSION=0.50.33
      - API_URL=https://etl.${DOMAIN}/api/v1/
      - INTERNAL_API_HOST=airbyte-server:8001
      - TRACKING_STRATEGY=logging
    networks:
      - agent-network
      - coolify
    depends_on:
      - airbyte-server
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.airbyte-web.rule=Host(`etl.${DOMAIN}`)"
      - "traefik.http.routers.airbyte-web.entrypoints=https"
      - "traefik.http.routers.airbyte-web.tls=true"
      - "traefik.http.routers.airbyte-web.tls.certresolver=letsencrypt"
      - "traefik.http.services.airbyte-web.loadbalancer.server.port=80"

  # Airbyte Worker (runs sync jobs)
  airbyte-worker:
    image: airbyte/worker:0.50.33
    container_name: agent-memz-airbyte-worker
    restart: unless-stopped
    environment:
      - AIRBYTE_VERSION=0.50.33
      - CONFIG_ROOT=/data
      - WORKSPACE_ROOT=/tmp/workspace
      - WORKER_ENVIRONMENT=DOCKER
      - LOCAL_ROOT=/tmp/airbyte_local
      - WEBAPP_URL=https://etl.${DOMAIN}
      - DATABASE_USER=${POSTGRES_USER:-agentmemz}
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD}
      - DATABASE_HOST=agent-memz-postgres
      - DATABASE_PORT=5432
      - DATABASE_DB=airbyte
      - INTERNAL_API_HOST=airbyte-server:8001
      - TEMPORAL_HOST=airbyte-temporal:7233
      - TRACKING_STRATEGY=logging
      - LOG_LEVEL=INFO
    volumes:
      - airbyte_workspace:/tmp/workspace
      - /var/run/docker.sock:/var/run/docker.sock
      - airbyte_data:/data
    networks:
      - agent-network
    depends_on:
      - airbyte-server
      - airbyte-temporal

  # Temporal (workflow engine for Airbyte)
  airbyte-temporal:
    image: temporalio/auto-setup:latest
    container_name: agent-memz-airbyte-temporal
    restart: unless-stopped
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-agentmemz}
      - POSTGRES_PWD=${POSTGRES_PASSWORD}
      - POSTGRES_SEEDS=agent-memz-postgres
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development.yaml
    ports:
      - "7233:7233"
    volumes:
      - airbyte_temporal:/etc/temporal/config/dynamicconfig
    networks:
      - agent-network

networks:
  agent-network:
    external: true
  coolify:
    external: true

volumes:
  airbyte_data:
    driver: local
  airbyte_workspace:
    driver: local
  airbyte_temporal:
    driver: local
